<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAME HUB (rex.io)</title>
    <style>
        /* --- 全局樣式與字體設定 --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        :root {
            --primary-color: #00aaff;
            --card-bg: rgba(20, 20, 30, 0.65);
            --text-color: #f0f0f0;
            --text-muted: #a0a0b0;
            --border-color: rgba(255, 255, 255, 0.2);
            --modal-bg: rgba(20, 20, 30, 0.95); /* 模態框內部背景 */
            --modal-border: rgba(0, 170, 255, 0.8); /* 模態框邊框顏色 */
            --control-bg: rgba(30, 30, 45, 0.9); /* 控制區背景 */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #050510; 
            color: var(--text-color); 
            overflow-x: hidden; 
            transition: overflow 0.3s ease; /* 為 body overflow 變化添加過渡 */
        }
        /* 當模態框打開時阻止主頁面滾動 */
        body.modal-open {
            overflow: hidden;
        }

        /* --- 動態背景輪播 --- */
        .background-slideshow { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; list-style: none; }
        .background-slideshow li {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            background-size: cover; background-position: center center;
            opacity: 0; 
            animation: imageAnimation 60s linear infinite;
        }
        .background-slideshow li:nth-child(1) { background-image: url('images/bg-1.jpg'), url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?auto=format&fit=crop&w=1470&q=80'); }
        .background-slideshow li:nth-child(2) { background-image: url('images/bg-2.jpg'), url('https://images.unsplash.com/photo-1554141311-929929384501?auto=format&fit=crop&w=1394&q=80'); animation-delay: 6s; }
        .background-slideshow li:nth-child(3) { background-image: url('images/bg-3.jpg'), url('https://images.unsplash.com/photo-1511447333015-45b65e60f6d5?auto=format&fit=crop&w=1555&q=80'); animation-delay: 12s; }
        .background-slideshow li:nth-child(4) { background-image: url('images/bg-4.jpg'), url('https://images.unsplash.com/photo-1604079628040-94301bb21b91?auto=format&fit=crop&w=1374&q=80'); animation-delay: 18s; }
        .background-slideshow li:nth-child(5) { background-image: url('images/bg-5.jpg'), url('https://images.unsplash.com/photo-1507525428034-b723a9ce6890?auto=format&fit=crop&w=1470&q=80'); animation-delay: 24s; }
        .background-slideshow li:nth-child(6) { background-image: url('images/bg-6.jpg'), url('https://images.unsplash.com/photo-1557682250-33bd709cbe85?auto=format&fit=crop&w=1429&q=80'); animation-delay: 30s; }
        .background-slideshow li:nth-child(7) { background-image: url('images/bg-7.jpg'), url('https://images.unsplash.com/photo-1553356084-58ef4a67b2a7?auto=format&fit=crop&w=1374&q=80'); animation-delay: 36s; }
        .background-slideshow li:nth-child(8) { background-image: url('images/bg-8.jpg'), url('https://images.unsplash.com/photo-1618005198919-d3d4b5a92ead?auto=format&fit=crop&w=1548&q=80'); animation-delay: 42s; }
        .background-slideshow li:nth-child(9) { background-image: url('images/bg-9.jpg'), url('https://images.unsplash.com/photo-1579546929662-711aa81148cf?auto=format&fit=crop&w=1470&q=80'); animation-delay: 48s; }
        .background-slideshow li:nth-child(10) { background-image: url('images/bg-10.jpg'), url('https://images.unsplash.com/photo-1605792637384-5275a3933b39?auto=format&fit=crop&w=1470&q=80'); animation-delay: 54s; }
        
        @keyframes imageAnimation {
            0% { opacity: 0; animation-timing-function: ease-in; }
            1% { opacity: 1; }
            9% { opacity: 1; }
            10% { opacity: 0; }
            100% { opacity: 0; }
        }

        /* --- 側邊欄與漢堡選單 --- */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1001; /* 必須比遮罩層高 */
            transform: translateX(-100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            padding-top: 5rem;
            border-right: 1px solid var(--border-color);
        }
        .sidebar ul { list-style: none; }
        .sidebar ul li a {
            display: block; padding: 1rem 2rem; color: var(--text-color);
            text-decoration: none; font-size: 1.1rem; font-weight: 500;
            transition: background-color 0.3s, color 0.3s;
        }
        .sidebar ul li a:hover, .sidebar ul li a.active {
            background-color: rgba(0, 170, 255, 0.2);
            color: var(--primary-color);
        }
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.5); z-index: 1000;
            opacity: 0; pointer-events: none;
            transition: opacity 0.35s ease-in-out;
        }
        .sidebar-toggle-btn {
            background: none; border: none; cursor: pointer; padding: 10px;
            z-index: 1002; /* 確保在最上層 */
            display: flex; flex-direction: column; justify-content: space-around;
            width: 40px; height: 40px;
        }
        .sidebar-toggle-btn .line {
            width: 100%; height: 3px; background-color: var(--text-color);
            border-radius: 3px; transition: all 0.3s ease-in-out;
        }

        /* 當側邊欄打開時的樣式變化 */
        body.sidebar-open .sidebar { transform: translateX(0); }
        body.sidebar-open .sidebar-overlay { opacity: 1; pointer-events: auto; }
        body.sidebar-open .sidebar-toggle-btn .line1 { transform: rotate(45deg) translate(7px, 7px); }
        body.sidebar-open .sidebar-toggle-btn .line2 { opacity: 0; }
        body.sidebar-open .sidebar-toggle-btn .line3 { transform: rotate(-45deg) translate(7px, -7px); }


        /* --- 頂部半透明選擇區 --- */
        header {
            position: sticky; top: 0; z-index: 100; padding: 1rem 2rem; background: rgba(10, 10, 20, 0.5);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; 
            gap: 1.5rem;
        }
        .logo { font-weight: 700; letter-spacing: 2px; text-shadow: 0 0 10px var(--primary-color); font-size: clamp(1.5rem, 5vw + 0.5rem, 1.8rem); }

        /* --- Collapsible Menu Styles --- */
        #toggle-filters-btn {
            display: none;
            padding: 0.6rem 1.2rem; font-size: 1rem; font-weight: 500;
            background-color: rgba(255, 255, 255, 0.1); color: var(--text-color);
            border: 1px solid var(--border-color); border-radius: 20px; cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .collapsible-menu {
            display: flex; align-items: center; gap: 1rem;
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out, padding 0.4s ease-in-out;
        }
        .search-wrapper { flex-shrink: 0; }
        #search-box {
            padding: 0.6rem 1rem; border-radius: 20px; border: 1px solid var(--border-color); background: rgba(255, 255, 255, 0.1);
            color: var(--text-color); font-size: 1rem; transition: all 0.3s ease;
        }
        #search-box:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 15px rgba(0, 170, 255, 0.5); }
        .filter-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .filter-buttons button {
            padding: 0.6rem 1.2rem; font-size: 1rem; font-weight: 500; color: var(--text-muted); background: transparent;
            border: 1px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.3s ease;
        }
        .filter-buttons button:hover, .filter-buttons button.active {
             color: #fff; background: var(--primary-color); border-color: var(--primary-color); box-shadow: 0 0 10px rgba(0, 170, 255, 0.7);
        }

        /* --- 滾動頁面推薦 --- */
        .scrolling-recommendations { width: 100%; background: linear-gradient(90deg, #ff8a00, #e52e71); color: white; padding: 0.5rem 0; overflow: hidden; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .scrolling-text { display: inline-block; padding-left: 100%; animation: scroll-left 30s linear infinite; font-weight: 500; font-size: 1.1rem; }
        .scrolling-text span { margin: 0 1.5rem; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        
        /* --- 卡片容器與樣式 --- */
        main { padding: 2rem; }
        .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 2rem; }
        .card {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; overflow: hidden; text-decoration: none; color: var(--text-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease; backdrop-filter: blur(5px); display: flex; flex-direction: column;
            cursor: pointer; /* 表示可點擊 */
        }
        .card:hover { transform: translateY(-10px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4); border-color: var(--primary-color); }
        .card:active { transform: translateY(-2px) scale(0.98); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); }
        .card-image { width: 100%; height: 200px; background-size: cover; background-position: center; }
        .card-content { padding: 1.5rem; display: flex; flex-direction: column; flex-grow: 1; }
        .card h3 { margin-bottom: 0.5rem; font-weight: 700; font-size: clamp(1.25rem, 4vw + 0.5rem, 1.5rem); }
        .card p { font-size: 1rem; color: var(--text-muted); line-height: 1.6; flex-grow: 1; margin-bottom: 1rem; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
        .tags-container { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .category-tag { padding: 0.3rem 0.8rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; }
        .category-tag.mobile-game { background-color: #f4511e; color: white; }
        .category-tag.desktop-game { background-color: #e53935; color: white; }
        .category-tag.app { background-color: #43a047; color: white; }
        
        /* --- 模態視窗通用樣式 --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9); /* 半透明黑色背景 */
            backdrop-filter: blur(5px); /* 背景模糊效果 */
            -webkit-backdrop-filter: blur(5px);
            display: none; /* 預設隱藏 */
            justify-content: center;
            align-items: center;
            opacity: 0; /* 用於過渡效果 */
            transition: opacity 0.3s ease;
            pointer-events: none; /* 隱藏時不阻擋點擊 */
        }
        .modal-overlay.is-active {
            opacity: 1;
            pointer-events: auto; /* 顯示時允許點擊 */
        }

        .modal-content {
            position: relative;
            background: var(--modal-bg);
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid var(--modal-border);
            box-shadow: 0 0 40px var(--primary-color);
            display: flex;
            flex-direction: column;
        }

        .modal-controls {
            display: flex;
            justify-content: flex-end; /* 按鈕靠右對齊 */
            gap: 10px;
            padding: 10px;
            background: var(--control-bg);
            height: 60px; /* 固定高度 */
            flex-shrink: 0; /* 不會被壓縮 */
            border-top: 1px solid var(--border-color);
        }

        .modal-control-btn {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-color);
            background-color: rgba(0, 170, 255, 0.2);
            border: 1px solid var(--primary-color);
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        }

        .modal-control-btn:hover {
            background-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(0, 170, 255, 0.7);
            transform: translateY(-2px);
        }

        .modal-control-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* --- 遊戲內嵌模態視窗樣式 (覆寫通用樣式) --- */
        #gameModal { z-index: 2000; }
        #gameModal .modal-content {
            width: 95%; /* 幾乎佔滿畫面的寬度 */
            height: 95%; /* 幾乎佔滿畫面的高度 */
        }
        #gameIframe {
            width: 100%;
            height: calc(100% - 60px); /* 留出底部空間給控制按鈕 */
            border: none;
            background-color: #050510; /* 加載時的背景色 */
        }

        /* --- 設定模態視窗樣式 --- */
        #settingsModal { z-index: 2001; } /* 比遊戲模態框高 */
        #settingsModal .modal-content {
            width: clamp(300px, 80%, 500px); /* 較小的設定框 */
            height: auto; /* 內容自適應 */
            padding: 1.5rem;
            text-align: center;
        }
        #settingsModal h3 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            text-shadow: 0 0 8px rgba(0, 170, 255, 0.5);
        }
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 0.8rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .setting-item:last-child { border-bottom: none; margin-bottom: 0; }
        .setting-item label {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-color);
            flex-grow: 1;
            text-align: left;
        }
        /* 音量滑塊樣式 */
        #volumeSlider {
            -webkit-appearance: none;
            appearance: none;
            width: 60%; /* 滑塊寬度 */
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            border-radius: 4px;
            transition: opacity .2s;
            cursor: pointer;
        }
        #volumeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 170, 255, 0.8);
        }
        #volumeSlider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 170, 255, 0.8);
        }
        /* 音量圖示按鈕 */
        .volume-icon-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: color 0.3s;
        }
        .volume-icon-btn:hover { color: white; }
        .volume-icon-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            color: var(--text-muted);
        }
        #volumeSlider:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* --- 歌曲列表樣式 --- */
        .song-list-container {
            max-height: 250px; /* 限制高度，使其可滾動 */
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 1.5rem;
            background-color: rgba(0, 0, 0, 0.3);
            text-align: left; /* 讓列表內容靠左 */
        }
        .song-list-container ul {
            list-style: none; /* 移除列表點 */
        }
        .song-item {
            padding: 0.8rem 1rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .song-item:last-child { border-bottom: none; }
        .song-item:hover {
            background-color: rgba(0, 170, 255, 0.1);
            color: white;
        }
        .song-item.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            box-shadow: inset 0 0 10px rgba(0, 170, 255, 0.5);
        }
        .song-item.active::before {
            content: '▶'; /* 播放圖示 */
            display: inline-block;
            margin-right: 5px;
            color: white;
        }

        /* 單曲循環按鈕 */
        #singleLoopToggleBtn {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-color);
            background-color: rgba(0, 170, 255, 0.2);
            border: 1px solid var(--primary-color);
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            margin-bottom: 1rem; /* 增加與下面控制按鈕的距離 */
        }
        #singleLoopToggleBtn:hover {
            background-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(0, 170, 255, 0.7);
            transform: translateY(-2px);
        }
        #singleLoopToggleBtn.active {
            background-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(0, 170, 255, 0.7);
        }
        #singleLoopToggleBtn:active {
            transform: translateY(0);
            box-shadow: none;
        }


        /* --- MOBILE OPTIMIZATIONS (max-width: 768px) --- */
        @media (max-width: 768px) {
            header { padding: 1rem; }
            .sidebar-toggle-btn { transform: scale(0.85); } /* 手機版按鈕稍小一點 */
            #toggle-filters-btn { display: flex; }
            .collapsible-menu {
                flex-basis: 100%; flex-direction: column; overflow: hidden;
                max-height: 0; opacity: 0; padding: 0;
            }
            .collapsible-menu.is-open { max-height: 500px; opacity: 1; padding: 1.5rem 0 0.5rem 0; }
            .search-wrapper { width: 100%; }
            #search-box { width: 100%; }
            .filter-buttons { justify-content: center; }
            main { padding: 1.5rem 1rem; }
            .card-container { grid-template-columns: 1fr; gap: 1.5rem; }
            .card p { line-height: 1.7; }
            .scrolling-text { animation-duration: 40s; }
            
            /* 手機版模態框調整 */
            #gameModal .modal-content {
                width: 98%;
                height: 98%;
            }
            #settingsModal .modal-content {
                width: 95%;
            }
            .setting-item label { font-size: 1rem; }
            #volumeSlider { width: 50%; } /* 手機上滑塊可以窄一點 */
            .volume-icon-btn { font-size: 1.3rem; }
            #singleLoopToggleBtn { padding: 0.6rem 1rem; font-size: 0.9rem; }
        }
        
        /* --- Desktop-specific layout (min-width: 769px) --- */
        @media (min-width: 769px) {
            .collapsible-menu {
                flex-grow: 1; /* Allow menu to take up space */
                justify-content: flex-end; /* Align items to the right */
            }
            #search-box {
                width: 280px; /* Set a specific width for the search box */
            }
        }
    </style>
</head>
<body>

    <!-- 背景音樂播放器 (預設靜音) -->
    <audio id="backgroundMusic" loop muted></audio>

    <!-- 側邊欄與遮罩層 -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
    <nav id="sidebar" class="sidebar">
        <ul>
            <li><a href="#" class="active">主頁</a></li>
            <li><a href="#" id="settingsLink">設定</a></li> <!-- 新增設定連結 -->
        </ul>
    </nav>

    <ul class="background-slideshow">
        <li></li><li></li><li></li><li></li><li></li>
        <li></li><li></li><li></li><li></li><li></li>
    </ul>

    <header>
        <!-- 漢堡選單按鈕 -->
        <button id="sidebar-toggle-btn" class="sidebar-toggle-btn" aria-label="Toggle Menu" aria-expanded="false">
            <span class="line line1"></span>
            <span class="line line2"></span>
            <span class="line line3"></span>
        </button>

        <div class="logo">GameHub</div>
        <button id="toggle-filters-btn" aria-controls="collapsible-menu" aria-expanded="false">篩選 ▼</button>
        <div class="collapsible-menu" id="collapsible-menu">
            <div class="search-wrapper">
                <input type="text" id="search-box" placeholder="搜索作品名稱...">
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">全部</button>
                <button class="filter-btn" data-filter="手遊">手遊</button>
                <button class="filter-btn" data-filter="桌機遊戲">桌機遊戲</button>
                <button class="filter-btn" data-filter="應用">應用</button>
            </div>
        </div>
    </header>
    
    <div class="scrolling-recommendations">
        <div class="scrolling-text">
             <span>🔥 熱門推薦：貓咪大亂鬥</span><span>✨ 最新上線：單字卡</span><span>🎮 經典必玩：黃金礦工</span>
             <span>🌲 冒險探索：叢林求生</span><span>🚀 桌機專屬：ChromaShock Arena</span>
        </div>
    </div>

    <main>
        <div class="card-container" id="card-container">
             <p style="color: var(--text-muted); font-size: 1.2rem; grid-column: 1 / -1; text-align: center;">正在載入作品中，請稍候...</p>
        </div>
    </main>

    <!-- 遊戲內嵌模態視窗 -->
    <div id="gameModal" class="modal-overlay">
        <div class="modal-content">
            <iframe id="gameIframe" src="" frameborder="0" allowfullscreen></iframe>
            <div class="modal-controls">
                <button id="openInNewTabBtn" class="modal-control-btn">在新分頁開啟</button>
                <button id="closeGameModalBtn" class="modal-control-btn">關閉</button>
            </div>
        </div>
    </div>

    <!-- 設定模態視窗 -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <h3>設定</h3>
            <div class="setting-item">
                <label for="volumeSlider">背景音樂音量</label>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0">
                <button id="muteToggleBtn" class="volume-icon-btn" aria-label="Toggle Mute">
                    <span class="mute-icon">🔇</span> <!-- 靜音圖示 -->
                </button>
            </div>
            <button id="singleLoopToggleBtn"><span>單曲循環 🔁</span></button> <!-- 新增單曲循環按鈕 -->

            <div class="song-list-container">
                <ul id="songList">
                    <!-- 歌曲列表將由 JavaScript 渲染到這裡 -->
                </ul>
            </div>

            <div class="modal-controls" style="border-top: none; padding-top: 0; justify-content: center;">
                <button id="closeSettingsModalBtn" class="modal-control-btn">關閉</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 全局模態框控制 ---
        function showModal(modalElement) {
            modalElement.style.display = 'flex';
            requestAnimationFrame(() => {
                modalElement.classList.add('is-active');
                document.body.classList.add('modal-open'); 
            });
        }

        function hideModal(modalElement) {
            modalElement.classList.remove('is-active');
            // Only remove modal-open if no other modal is active
            setTimeout(() => {
                modalElement.style.display = 'none';
                if (!document.querySelector('.modal-overlay.is-active')) {
                    document.body.classList.remove('modal-open');
                }
            }, 300); 
        }

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (event) => {
                if (event.target === overlay) {
                    hideModal(overlay);
                }
            });
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                // 找到最上層的模態框並關閉它
                const activeModals = Array.from(document.querySelectorAll('.modal-overlay.is-active'));
                if (activeModals.length > 0) {
                    // 假設最後一個是最新打開的，或最頂層的
                    hideModal(activeModals[activeModals.length - 1]);
                }
            }
        });


        // --- 側邊欄控制 ---
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        
        const toggleSidebar = () => {
            document.body.classList.toggle('sidebar-open');
            const isSidebarOpen = document.body.classList.contains('sidebar-open');
            sidebarToggleBtn.setAttribute('aria-expanded', isSidebarOpen);
        };

        sidebarToggleBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);
        // --- 側邊欄控制結束 ---


        // --- 遊戲內嵌模態視窗控制 ---
        const gameModal = document.getElementById('gameModal');
        const gameIframe = document.getElementById('gameIframe');
        const closeGameModalBtn = document.getElementById('closeGameModalBtn');
        const openInNewTabBtn = document.getElementById('openInNewTabBtn');

        function showGameModal(url) {
            gameIframe.src = url;
            openInNewTabBtn.onclick = () => window.open(url, '_blank'); 
            showModal(gameModal);
        }

        function hideGameModal() {
            hideModal(gameModal);
            gameIframe.src = ''; 
        }

        closeGameModalBtn.addEventListener('click', hideGameModal);


        // --- 背景音樂播放控制 ---
        const settingsLink = document.getElementById('settingsLink');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
        const backgroundMusic = document.getElementById('backgroundMusic');
        const volumeSlider = document.getElementById('volumeSlider');
        const muteToggleBtn = document.getElementById('muteToggleBtn');
        const muteIcon = muteToggleBtn.querySelector('.mute-icon');
        const singleLoopToggleBtn = document.getElementById('singleLoopToggleBtn'); // 新增單曲循環按鈕
        const songListElement = document.getElementById('songList'); // 新增歌曲列表元素

        // 請在此處填寫您的 MP3 檔案路徑與名稱
        const audioPlaylist = [
            { path: 'images/music1.mp3', name: '輕快背景樂' }, 
            { path: 'images/music2.mp3', name: '史詩戰鬥曲' }, 
            { path: 'images/music3.mp3', name: '奇幻冒險旋律' },
            { path: 'images/music4.mp3', name: '寧靜夜晚' },
            { path: 'images/music5.mp3', name: '歡樂遊戲時間' },
            { path: 'images/music6.mp3', name: '未來科技感' },
            { path: 'images/music7.mp3', name: '神秘地牢' },
            { path: 'images/music8.mp3', name: '復古像素風' },
            { path: 'images/music9.mp3', name: '高能節奏' },
            { path: 'images/music10.mp3', name: '勝利凱歌' }
        ];
        let currentAudioIndex = 0;
        let failedAttemptsCount = 0; // 追蹤連續失敗的次數
        let isSingleLoop = false; // 控制單曲循環狀態

        // 輔助函數：禁用音量控制
        function disableAudioControls() {
            backgroundMusic.pause();
            backgroundMusic.src = '';
            volumeSlider.disabled = true;
            muteToggleBtn.disabled = true;
            singleLoopToggleBtn.disabled = true; // 禁用單曲循環按鈕
            muteIcon.textContent = '🔇';
            muteToggleBtn.setAttribute('aria-label', 'Audio disabled');
            localStorage.setItem('audioControlsDisabled', 'true');
            console.log("所有音頻檔案都無法載入或播放，已禁用音樂控制。");
        }

        // 輔助函數：啟用音量控制
        function enableAudioControls() {
            volumeSlider.disabled = false;
            muteToggleBtn.disabled = false;
            singleLoopToggleBtn.disabled = false; // 啟用單曲循環按鈕
            localStorage.setItem('audioControlsDisabled', 'false');
            updateMuteIcon();
        }

        function updateMuteIcon() {
            if (backgroundMusic.muted || backgroundMusic.volume === 0) {
                muteIcon.textContent = '🔇';
                muteToggleBtn.setAttribute('aria-label', 'Unmute');
            } else {
                muteIcon.textContent = '🔊';
                muteToggleBtn.setAttribute('aria-label', 'Mute');
            }
        }

        // 播放指定索引的歌曲
        function playAudioByIndex(index, forcePlay = false) {
            if (audioPlaylist.length === 0) {
                disableAudioControls();
                return;
            }

            // 確保索引在有效範圍內
            index = index % audioPlaylist.length;
            if (index < 0) index = audioPlaylist.length + index; // 處理負數索引 (儘管這裡不會發生)

            // 如果所有歌曲都嘗試過且都失敗，則停止 (除非是強制播放)
            if (failedAttemptsCount >= audioPlaylist.length && !forcePlay) {
                disableAudioControls();
                return;
            }

            currentAudioIndex = index;
            backgroundMusic.src = audioPlaylist[currentAudioIndex].path;
            backgroundMusic.load(); // 確保新 src 被載入

            backgroundMusic.loop = isSingleLoop; // 套用單曲循環設定

            const playPromise = backgroundMusic.play();
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        console.log(`正在播放: ${audioPlaylist[currentAudioIndex].name}`);
                        failedAttemptsCount = 0; // 成功播放，重置失敗計數
                        enableAudioControls(); // 確保音量控制是啟用的
                        updateSongListUI(); // 更新歌曲列表 UI
                    })
                    .catch(error => {
                        console.warn(`自動播放或載入失敗 (${audioPlaylist[currentAudioIndex].name}):`, error);
                        failedAttemptsCount++; // 增加失敗計數
                        
                        // 如果這次播放失敗了，並且不是單曲循環模式，或者即使是單曲循環但來源檔案都載入失敗了，才嘗試播放下一首
                        // 如果是單曲循環且文件存在但只是自動播放被阻止，我們不應該跳到下一首，而是等待用戶互動
                        if (!isSingleLoop || error.name === 'MediaError' || backgroundMusic.networkState === HTMLMediaElement.NETWORK_EMPTY) {
                             currentAudioIndex = (currentAudioIndex + 1) % audioPlaylist.length;
                             playAudioByIndex(currentAudioIndex); // 遞歸調用，嘗試下一首
                        } else {
                            // 如果是單曲循環模式，且不是文件載入錯誤，則停止並等待用戶互動
                            backgroundMusic.pause();
                            updateSongListUI(); // 依然更新 UI 狀態
                        }
                    });
            }
        }

        // 監聽音頻載入失敗事件 (例如檔案不存在或損壞)
        backgroundMusic.addEventListener('error', (e) => {
            console.error(`載入音頻檔案失敗: ${backgroundMusic.src}. Error code: ${e.target.error.code}. 跳過此曲。`);
            failedAttemptsCount++; // 增加失敗計數
            currentAudioIndex = (currentAudioIndex + 1) % audioPlaylist.length;
            playAudioByIndex(currentAudioIndex); // 嘗試播放下一首
        });

        // 當前歌曲播放結束時，自動播放下一首 (僅在非單曲循環模式下)
        backgroundMusic.addEventListener('ended', () => {
            // 這個事件只在 backgroundMusic.loop 為 false 時觸發
            // 如果 isSingleLoop 為 true，backgroundMusic.loop 會是 true，導致此事件不觸發，由瀏覽器自行循環
            if (!isSingleLoop) { 
                currentAudioIndex = (currentAudioIndex + 1) % audioPlaylist.length;
                playAudioByIndex(currentAudioIndex);
            }
        });

        function initializeAudioControls() {
            if (audioPlaylist.length === 0) {
                disableAudioControls();
                return;
            }

            // 載入 localStorage 中的狀態
            const audioDisabledPermanently = localStorage.getItem('audioControlsDisabled') === 'true';
            const savedVolume = parseFloat(localStorage.getItem('backgroundVolume'));
            const savedMuted = localStorage.getItem('backgroundMuted') === 'true';
            isSingleLoop = localStorage.getItem('isSingleLoop') === 'true'; // 載入單曲循環狀態

            // 套用載入的狀態
            backgroundMusic.volume = isNaN(savedVolume) ? 0 : savedVolume; // 預設靜音且音量為0
            backgroundMusic.muted = savedMuted || true; // 預設靜音
            backgroundMusic.loop = isSingleLoop; // 套用單曲循環設定

            // 更新 UI
            volumeSlider.value = backgroundMusic.volume;
            if (backgroundMusic.muted) {
                 volumeSlider.value = 0; // 靜音時滑塊顯示為0
            }
            singleLoopToggleBtn.classList.toggle('active', isSingleLoop); // 更新單曲循環按鈕狀態
            updateMuteIcon();

            // 如果之前所有音樂都失敗了，就保持禁用
            if (audioDisabledPermanently) {
                disableAudioControls(); 
            } else {
                enableAudioControls(); // 確保啟用，然後嘗試播放
                // 由於瀏覽器自動播放政策，這裡的 play() 可能會失敗
                // 會在 playAudioByIndex 內部處理錯誤和嘗試下一首
                playAudioByIndex(currentAudioIndex); 
            }

            // 事件監聽器
            volumeSlider.addEventListener('input', () => {
                backgroundMusic.volume = volumeSlider.value;
                backgroundMusic.muted = (volumeSlider.value == 0); // 滑到0自動靜音
                localStorage.setItem('backgroundVolume', backgroundMusic.volume);
                localStorage.setItem('backgroundMuted', backgroundMusic.muted);
                updateMuteIcon();
                // 如果是從靜音狀態解除，且音樂被瀏覽器阻止，嘗試播放
                if (!backgroundMusic.muted && backgroundMusic.paused) {
                    backgroundMusic.play().catch(error => {
                        console.warn("無法自動播放背景音樂，可能需要用戶再次互動。", error);
                    });
                }
            });

            muteToggleBtn.addEventListener('click', () => {
                backgroundMusic.muted = !backgroundMusic.muted;
                if (!backgroundMusic.muted && backgroundMusic.volume === 0) {
                    backgroundMusic.volume = 0.5; // 如果從靜音恢復，音量設為0.5
                    volumeSlider.value = 0.5;
                } else if (backgroundMusic.muted) {
                    volumeSlider.value = 0; 
                }
                localStorage.setItem('backgroundMuted', backgroundMusic.muted);
                localStorage.setItem('backgroundVolume', backgroundMusic.volume);
                updateMuteIcon();
                if (!backgroundMusic.muted && backgroundMusic.paused) {
                    backgroundMusic.play().catch(error => {
                        console.warn("無法自動播放背景音樂，可能需要用戶再次互動。", error);
                    });
                }
            });

            // 單曲循環按鈕監聽器
            singleLoopToggleBtn.addEventListener('click', () => {
                isSingleLoop = !isSingleLoop;
                backgroundMusic.loop = isSingleLoop; // 更新 audio 元素的 loop 屬性
                singleLoopToggleBtn.classList.toggle('active', isSingleLoop);
                localStorage.setItem('isSingleLoop', isSingleLoop); // 保存狀態
                
                // 如果取消單曲循環，且音樂因為循環結束而暫停了（如果之前是手動播放或因錯誤暫停）
                // 則嘗試播放下一首 (僅當前音頻源已設置且已暫停時)
                if (!isSingleLoop && backgroundMusic.paused && backgroundMusic.src) {
                    // 如果 backgroundMusic.loop 之前是 true，ended事件不會觸發，所以這裡手動觸發下一首
                    currentAudioIndex = (currentAudioIndex + 1) % audioPlaylist.length;
                    playAudioByIndex(currentAudioIndex);
                }
            });

            // 歌曲列表點擊事件委託
            songListElement.addEventListener('click', (event) => {
                const clickedItem = event.target.closest('.song-item');
                if (clickedItem) {
                    const index = parseInt(clickedItem.dataset.index, 10);
                    if (!isNaN(index) && index >= 0 && index < audioPlaylist.length) {
                        playAudioByIndex(index, true); // 強制播放，用戶選擇優先
                        hideModal(settingsModal); // 播放後關閉設定頁
                    }
                }
            });
        }
        
        // 渲染歌曲列表
        function renderSongList() {
            songListElement.innerHTML = ''; // 清空現有列表
            if (audioPlaylist.length === 0) {
                songListElement.innerHTML = '<li>沒有可用的背景音樂。</li>';
                return;
            }
            audioPlaylist.forEach((song, index) => {
                const li = document.createElement('li');
                li.classList.add('song-item');
                li.dataset.index = index; // 儲存索引，方便點擊時獲取
                li.textContent = song.name;

                // 高亮當前播放的歌曲
                if (index === currentAudioIndex && !backgroundMusic.paused && backgroundMusic.src === song.path) {
                    li.classList.add('active');
                }
                songListElement.appendChild(li);
            });
        }

        // 顯示設定模態框
        function showSettingsModal() {
            showModal(settingsModal);
            renderSongList(); // 每次打開設定都重新渲染列表，確保狀態正確
            
            // 確保設定模態框打開時，音量滑塊和靜音狀態同步
            volumeSlider.value = backgroundMusic.volume;
            if (backgroundMusic.muted) {
                volumeSlider.value = 0;
            }
            // 確保音量滑塊和靜音按鈕的禁用狀態正確
            if (localStorage.getItem('audioControlsDisabled') === 'true') {
                volumeSlider.disabled = true;
                muteToggleBtn.disabled = true;
                singleLoopToggleBtn.disabled = true;
            } else {
                volumeSlider.disabled = false;
                muteToggleBtn.disabled = false;
                singleLoopToggleBtn.disabled = false;
            }
            singleLoopToggleBtn.classList.toggle('active', isSingleLoop); // 更新單曲循環按鈕
            updateMuteIcon(); 
        }

        // 設定連結點擊事件
        settingsLink.addEventListener('click', (event) => {
            event.preventDefault();
            showSettingsModal();
            if (document.body.classList.contains('sidebar-open')) {
                toggleSidebar();
            }

            // **新邏輯：如果音樂沒有正在播放或之前已禁用，則重新搜索**
            const audioDisabledPermanently = localStorage.getItem('audioControlsDisabled') === 'true';
            // backgroundMusic.paused 為 true 的情況包括:
            // 1. 歌曲播放完畢 (非loop)
            // 2. 被手動暫停
            // 3. 瀏覽器阻止了自動播放
            // backgroundMusic.src === '' 意味著沒有任何歌曲載入
            if (backgroundMusic.paused || backgroundMusic.src === '' || audioDisabledPermanently) {
                console.log("偵測到音樂未播放或上次嘗試失敗/永久禁用，重新搜索音樂。");
                failedAttemptsCount = 0; // 重置失敗計數
                currentAudioIndex = 0; // 從第一首歌曲開始嘗試
                enableAudioControls(); // 重新啟用控制（在嘗試播放之前）
                playAudioByIndex(currentAudioIndex, true); // 強制播放嘗試
            }
        });
        closeSettingsModalBtn.addEventListener('click', () => hideModal(settingsModal));


        // --- 項目資料與渲染 ---
        const projects = [
            { title: '睡夢遊戲', url: 'https://gabriel-0927.github.io/sleeping/sleep.html', description: '一款探索夢境與現實的奇幻遊戲，在睡夢中解開謎題，尋找真相。', localImage: 'images/sleeping-game.jpg', fallbackImage: 'https://images.pexels.com/photos/1624496/pexels-photo-1624496.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', category: ['手遊', '桌機遊戲'] },
            { title: '貓咪大亂鬥', url: 'https://gabriel-0927.github.io/Cat-brawl/', description: '集結你的貓咪軍團！充滿策略與趣味的塔防對戰遊戲，萌貓出擊，無人能敵。', localImage: 'images/cat-brawl.jpg', fallbackImage: 'https://images.pexels.com/photos/1741205/pexels-photo-1741205.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', category: ['手遊', '桌機遊戲'] },
            { title: '黃金礦工', url: 'https://gabriel-0927.github.io/gold-miner/', description: '經典重現！操作你的鉤爪，在限定時間內抓取地下的黃金與寶藏，挑戰高分。', localImage: 'images/gold-miner.jpg', fallbackImage: 'https://images.pexels.com/photos/85768/gold-gold-nugget-nuggets-minerals-85768.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', category: ['手遊', '桌機遊戲'] },
            { title: '叢林求生', url: 'https://rex971008.github.io/Jungle-Survival2/JungleSurvival.html', description: '你墜落在未知的叢林中，必須利用智慧和勇氣，尋找資源，建造庇護所，努力活下去。', localImage: 'images/jungle-survival.jpg', fallbackImage: 'https://images.pexels.com/photos/1528640/pexels-photo-1528640.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', category: ['手遊', '桌機遊戲'] },
            { title: '迷宮遊戲', url: 'https://rex971008.github.io/maze/Maze_exploration_games.html', description: '挑戰你的方向感和邏輯思維，在複雜的迷宮中找到唯一的出口，你能多快完成？', localImage: 'images/maze-game.jpg', fallbackImage: 'https://images.pexels.com/photos/158471/pexels-photo-158471.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', category: ['手遊', '桌機遊戲'] },
            { title: '收集星星', url: 'https://rex971008.github.io/starcollect/starcollect.html', description: '在限定時間內收集所有閃爍的星星，挑戰你的反應速度和操作技巧。', localImage: 'images/star-collect.jpg', fallbackImage: 'https://images.pexels.com/photos/1252890/pexels-photo-1252890.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', category: ['手遊', '桌機遊戲'] },
            { title: '賽車起跑', url: 'https://rex971008.github.io/racingstart/racing%20start.html', description: '屏住呼吸，在信號燈熄滅的瞬間完美起跑！考驗你極限反應的賽車遊戲。', localImage: 'images/racing-start.jpg', fallbackImage: 'https://images.pexels.com/photos/3802510/pexels-photo-3802510.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', category: ['手遊', '桌機遊戲'] },
            { title: '胡鬧貓廚房', url: 'https://rex971008.github.io/kitchen_katterwaul/kitchen_katterwaul.html', description: '與朋友合作或對抗，在混亂的廚房中完成訂單！考驗你們的默契與反應。', localImage: 'images/kitchen-katterwaul.jpg', fallbackImage: 'https://images.pexels.com/photos/887827/pexels-photo-887827.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', category: ['手遊', '桌機遊戲'] },
            { title: '你畫我猜', url: 'https://gabriel-0927.github.io/draw/draw.html', description: '免下載，直接開玩。一人畫圖，大家猜詞，考驗你的繪畫功力與猜謎速度！快揪朋友比畫、比猜！', localImage: 'images/ai-drawing.jpg', fallbackImage: 'https://images.pexels.com/photos/8386440/pexels-photo-8386440.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', category: ['手遊', '桌機遊戲'] },
            { title: 'ChromaShock Arena', url: 'https://rex971008.github.io/ChromaShockArena/', description: '進入色彩斑斕的競技場，體驗快節奏的射擊對決。精準的槍法和靈活的走位是致勝關鍵。', localImage: 'images/chromashock-arena.jpg', fallbackImage: 'https://images.unsplash.com/photo-1552820728-8b83bb6b773f?auto=format&fit=crop&q=80&w=1470', category: ['桌機遊戲'] },
            { title: 'TOUR EATS', url: 'https://rex971008.github.io/tour_eats_v1.1/code.html', description: '結合旅遊與美食的探索應用。發現你所在地的特色餐廳，規劃一場完美的味蕾之旅。', localImage: 'images/tour-eats.jpg', fallbackImage: 'https://images.unsplash.com/photo-1555939594-58d7cb561ad1?auto=format&fit=crop&q=80&w=1374', category: ['應用'] },
            { title: '單字卡', url: 'https://rex971008.github.io/flashcard/flashcard.html', description: '一個簡潔有效的單字卡應用，幫助您學習和記憶新詞彙，讓複習事半功倍。', localImage: 'images/flashcard.jpg', fallbackImage: 'https://images.unsplash.com/photo-1456513080510-7bf3a84b82f8?auto=format&fit=crop&q=80&w=1470', category: ['應用'] },
            { title: '拍貼機', url: 'https://stellar-muffin-de6334.netlify.app/', description: '選擇喜歡的相框，製作屬於你的個性化拍貼照片，留下美好回憶。', localImage: 'images/photo-booth.jpg', fallbackImage: 'https://images.pexels.com/photos/1090638/pexels-photo-1090638.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', category: ['應用'] },
            { title: '官方網站 (v2.4.7)', url: 'https://sage-stardust-00287b.netlify.app/', description: '團隊或個人的官方門戶，展示核心理念、最新動態與所有專案的集合地。全新的客服系統與閱歷點餐系統將會於未來實際運用。建議創建帳號並且允許通知。', localImage: 'images/official-website.jpg', fallbackImage: 'https://images.pexels.com/photos/326503/pexels-photo-326503.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', category: ['應用'] }
        ];

        const cardContainer = document.getElementById('card-container');
        const searchBox = document.getElementById('search-box');
        const filterButtons = document.querySelectorAll('.filter-btn');
        let processedProjects = [];

        const toggleBtn = document.getElementById('toggle-filters-btn');
        const collapsibleMenu = document.getElementById('collapsible-menu');

        function updateMenuState(isOpen) {
            collapsibleMenu.classList.toggle('is-open', isOpen);
            toggleBtn.setAttribute('aria-expanded', isOpen);
            toggleBtn.textContent = isOpen ? '收合 ▲' : '篩選 ▼';
        }

        toggleBtn.addEventListener('click', () => {
            const isOpen = !collapsibleMenu.classList.contains('is-open');
            updateMenuState(isOpen);
        });

        function handleOutsideInteraction(event) {
            if (!collapsibleMenu.classList.contains('is-open')) return;
            if (toggleBtn.contains(event.target) || collapsibleMenu.contains(event.target)) return;
            updateMenuState(false);
        }

        document.addEventListener('click', handleOutsideInteraction);
        document.addEventListener('touchstart', handleOutsideInteraction);

        function checkImage(localPath, fallbackPath) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(localPath);
                img.onerror = () => resolve(fallbackPath);
                img.src = localPath;
            });
        }
        
        function renderCards(projectsToRender) {
            cardContainer.innerHTML = '';
            if (projectsToRender.length === 0) {
                cardContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 1.2rem; grid-column: 1 / -1; text-align: center;">找不到符合條件的項目...<p>';
                return;
            }
            const categoryClassMap = { '手遊': 'mobile-game', '桌機遊戲': 'desktop-game', '應用': 'app' };
            projectsToRender.forEach(project => {
                const tagsHTML = project.category.map(cat => `<span class="category-tag ${categoryClassMap[cat] || ''}">${cat}</span>`).join('');
                cardContainer.innerHTML += `
                    <div class="card" data-game-url="${project.url}">
                        <div class="card-image" style="background-image: url('${project.finalImage}')"></div>
                        <div class="card-content"><h3>${project.title}</h3><p>${project.description}</p>
                            <div class="card-footer"><div class="tags-container">${tagsHTML}</div></div>
                        </div>
                    </div>`;
            });
        }

        function filterAndSearch() {
            const searchTerm = searchBox.value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            const filteredProjects = processedProjects.filter(project => 
                (activeFilter === 'all' || project.category.includes(activeFilter)) && project.title.toLowerCase().includes(searchTerm)
            );
            renderCards(filteredProjects);
        }

        async function initializePage() {
            const imageChecks = projects.map(p => checkImage(p.localImage, p.fallbackImage));
            const finalImagePaths = await Promise.all(imageChecks);
            processedProjects = projects.map((project, index) => ({ ...project, finalImage: finalImagePaths[index] }));
            
            filterAndSearch();

            cardContainer.addEventListener('click', (event) => {
                const card = event.target.closest('.card');
                if (card && card.dataset.gameUrl) {
                    event.preventDefault();
                    showGameModal(card.dataset.gameUrl);
                }
            });

            searchBox.addEventListener('input', filterAndSearch);
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    filterAndSearch();
                });
            });

            initializeAudioControls();
        }

        initializePage();
    });
    </script>

</body>
</html>